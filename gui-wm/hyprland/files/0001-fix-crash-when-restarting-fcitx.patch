From 2cea9f4827f8721c6c09ccdc6ee9c0b73e13b873 Mon Sep 17 00:00:00 2001
From: yangyingchao <yang.yingchao@qq.com>
Date: Wed, 12 Jun 2024 17:48:37 +0800
Subject: [PATCH] fix crash when restarting fcitx

---
 src/protocols/InputMethodV2.cpp   | 4 ++--
 src/protocols/VirtualKeyboard.cpp | 4 ++--
 2 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/src/protocols/InputMethodV2.cpp b/src/protocols/InputMethodV2.cpp
index 5d0bd417..24f7ad54 100644
--- a/src/protocols/InputMethodV2.cpp
+++ b/src/protocols/InputMethodV2.cpp
@@ -81,7 +81,7 @@ SP<CInputMethodV2> CInputMethodKeyboardGrabV2::getOwner() {
 }
 
 wl_client* CInputMethodKeyboardGrabV2::client() {
-    return resource->client();
+    return resource->resource() ? resource->client() : nullptr;
 }
 
 CInputMethodPopupV2::CInputMethodPopupV2(SP<CZwpInputPopupSurfaceV2> resource_, SP<CInputMethodV2> owner_, SP<CWLSurfaceResource> surface) : resource(resource_), owner(owner_) {
@@ -373,4 +373,4 @@ void CInputMethodV2Protocol::onGetIME(CZwpInputMethodManagerV2* mgr, wl_resource
     LOGM(LOG, "New IME with resource id {}", id);
 
     events.newIME.emit(RESOURCE);
-}
\ No newline at end of file
+}
diff --git a/src/protocols/VirtualKeyboard.cpp b/src/protocols/VirtualKeyboard.cpp
index 89b14c32..009c277c 100644
--- a/src/protocols/VirtualKeyboard.cpp
+++ b/src/protocols/VirtualKeyboard.cpp
@@ -100,7 +100,7 @@ wlr_keyboard* CVirtualKeyboardV1Resource::wlr() {
 }
 
 wl_client* CVirtualKeyboardV1Resource::client() {
-    return resource->client();
+    return resource->resource() ? resource->client() : nullptr;
 }
 
 void CVirtualKeyboardV1Resource::releasePressed() {
@@ -151,4 +151,4 @@ void CVirtualKeyboardProtocol::onCreateKeeb(CZwpVirtualKeyboardManagerV1* pMgr,
     LOGM(LOG, "New VKeyboard at id {}", id);
 
     events.newKeyboard.emit(RESOURCE);
-}
\ No newline at end of file
+}
-- 
2.44.2

